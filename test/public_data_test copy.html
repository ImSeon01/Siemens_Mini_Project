<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>공공데이터</title>
    <!--jQuery-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.3/jquery.min.js"></script>
    <!--Load the AJAX API-->
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
</head>

<body>
    <button onclick="show_chart()">확인</button>
    <!--차트가 들어갈 DIV 영역-->
    <div id="chart_div"></div>

    <script>
        let times = new Array();
        $(function () {
           
            // 어제 날짜 구하기
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1) < 10 ? '0' + (today.getMonth() + 1) : (today.getMonth() + 1);
            const date = today.getDate() - 1 < 10 ? '0' + (today.getDate() - 1) : (today.getDate() - 1);
            const base_date = year.toString() + month + date;

            // 어제 기온을 담을 배열
            
            // 단기예보 조회서비스
            function select_tmp(base_time){
                $.ajax(
                    {
                        // 서비스를 요청할 url
                        url : "https://apis.data.go.kr/1360000/VilageFcstInfoService_2.0/getVilageFcst",
                        // 요청시 보낼 데이터
                        data : {
                            // 서비스키
                            serviceKey : "6SPFH0kJC57EY3tgIjMn7ZPrhX5UkJlauz0ErFzfD2gdu/HMVOrcHisBv6e3ctu5h8OD/o1ZN8LCOmgHg0h+eg==",
                            // 응답자료형식
                            dataType : "JSON",
                            // 조회를 원하는 날짜 YYYYMMDD 형식
                            base_date : base_date,
                            // 0200, 0500, 0800, 1100, 1400, 1700, 2000, 2300 (1일 8회)
                            base_time : base_time,
                            // 좌표
                            nx : "55",
                            ny : "124"
                        },
                        success : function(result){
                            let time = result.response.body.items.item[0].baseTime;
                            let tmp = result.response.body.items.item[0].fcstValue;
                            times.push({
                                time,
                                tmp
                            });
                        },
                        error : function(){
                            console.log(e);
                        },
                        complete : function(){

                        }
                    }
                )
                // end ajax
            }
            // 0200, 0500, 0800, 1100, 1400, 1700, 2000, 2300 (1일 8회)
            for (let i = 2; i < 24; i += 3) {
                
                let base_time = (i < 10 ? '0' + i : i) + '00';
                let msg = '';
                select_tmp(base_time, i);
            }// end for문]
        })// end $(function(){})

        let show_chart = () =>{
            times.sort((a,b) => a.time - b.time );

            // 구글 오픈 API에서 차트 객체 로드 
            google.charts.load('current', {'packages':['corechart']});
            // Google Visualization API  로드시 callback 사용할 콜백 함수 설정.
            google.charts.setOnLoadCallback(drawChart);
            // 이 함수에서 데이터 설정 및 차트를 그린다.
            function drawChart() {
                // 구글 차트는 데이터 테이블이라는 객체로 차트의 데이터를 전달한다.
                var data = new google.visualization.DataTable();
                //열 설정 2개를 설정하고 데이터 타입, 열이름
                data.addColumn('string', '관측 시간');
                data.addColumn('number', '온도');
                //행 추가
                for(const t of times){
                    data.addRows([
                    [t.time, Number(t.tmp)]
                    ]);
                }
                // chart 옵션 설정 범례, 가로 세로 
                var options = {'title':'어제의 기온',
                            'width':400,
                            'height':300};
                // 파이 차트 객체 생성 및 div 태그에 내용 전달
                var chart = new google.visualization.BarChart(document.getElementById('chart_div'));
                //차트 그리고 태그, 옵션
                chart.draw(data, options);
            }
        }
    </script>

</body>

</html>